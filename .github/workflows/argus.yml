name: Argus-AI-Threat Intelligence

on:
  workflow_dispatch: {}
  schedule:
    # 30분마다 (GitHub Actions cron은 UTC 기준)
    - cron: "*/30 * * * *"

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      # === Required secrets ===
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      VULNCHECK_API_KEY: ${{ secrets.VULNCHECK_API_KEY }}
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}

      # === Storage ===
      USE_STORAGE: "true"
      STORAGE_BUCKET: "argus"
      REPORT_TTL_DAYS: "30"  # Signed URL expiration days (housekeeping uses TTL+buffer)

      # === Optional: safety / diagnostics ===
      ARGUS_SELFTEST: "false"
      ARGUS_SETTINGS_CACHE_TTL_SEC: "300"

      # (Optional) If you want to set hard caps via env too.
      # DB settings override will be injected into env at runtime by runtime_overrides.py.
      # ARGUS_RULE_TEXT_MAX_BYTES_PER_RULE: "20000"
      # ARGUS_ZIP_MAX_RULES_TOTAL: "200"
      # ARGUS_ZIP_MAX_RULES_PER_ENGINE: "80"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Debug - dump rules_official init
        run: |
          echo "===== GIT ====="
          git rev-parse HEAD
          git status --porcelain
          echo "===== FILE EXISTS? ====="
          ls -la src/rules_official || true
          echo "===== __init__.py (HEAD) ====="
          python - <<'PY'
          import pathlib
          p = pathlib.Path("src/rules_official/__init__.py")
          print("exists:", p.exists())
          print("path:", p.resolve())
          if p.exists():
            print(p.read_text(encoding="utf-8", errors="ignore")[:2000])
          PY
          echo "===== IMPORT INSPECT ====="
          python - <<'PY'
          import importlib
          m = importlib.import_module("src.rules_official")
          print("module file:", m.__file__)
          print("has fetch_official_rules:", hasattr(m, "fetch_official_rules"))
          print("dir(fetch*):", [x for x in dir(m) if "fetch" in x])
          PY

      - name: Debug dump rules_official init
        run: |
          echo "===== src/rules_official/__init__.py (HEAD) ====="
          sed -n '1,200p' src/rules_official/__init__.py
          echo "===== python import inspect ====="
          python - <<'PY'
          import src.rules_official as m
          print("module file:", m.__file__)
          print("has fetch_official_rules:", hasattr(m, "fetch_official_rules"))
          print("dir contains:", [x for x in dir(m) if "fetch" in x or "official" in x])
          PY

      - name: Run Argus
        run: |
          python -m src.main
