/**
 * Argus CVE Dashboard
 * 검색, 필터, 정렬, 페이지네이션
 */

let allCves = [];
let filteredCves = [];
let statsData = {};
let currentPage = 1;
const PAGE_SIZE = 50;
let sortField = 'date';
let sortDir = -1; // -1 = desc
let activeFilters = { severity: new Set(['Critical', 'High', 'Medium', 'Low', 'None']), search: '', vendor: '' };

// ===== 초기화 =====
async function init() {
  showLoading(true);
  try {
    const [cveRes, statsRes] = await Promise.all([
      fetch('data/cves.json').then(r => r.json()),
      fetch('data/stats.json').then(r => r.json()),
    ]);
    allCves = cveRes;
    statsData = statsRes;
    renderStats();
    renderChart();
    buildVendorFilter();
    applyFilters();
  } catch (e) {
    console.error('Data load failed:', e);
    document.getElementById('cve-table-body').innerHTML =
      '<tr><td colspan="7" class="empty-state"><div class="icon">&#128268;</div><p>데이터를 불러올 수 없습니다. GitHub Actions에서 export를 실행해주세요.</p></td></tr>';
  }
  showLoading(false);
}

function showLoading(show) {
  const el = document.getElementById('loading');
  if (el) el.style.display = show ? 'block' : 'none';
}

// ===== 통계 카드 =====
function renderStats() {
  const s = statsData.cve || {};
  setText('stat-total', s.total || allCves.length);
  setText('stat-high', (s.severity?.Critical || 0) + (s.severity?.High || 0));
  setText('stat-kev', s.kev_count || 0);
  setText('stat-24h', s.recent_24h || 0);

  // 업데이트 시간
  if (statsData.generated_at) {
    const d = new Date(statsData.generated_at);
    setText('updated-time', d.toLocaleString('ko-KR'));
  }

  // 심각도 분포 바
  if (s.severity) {
    drawSeverityBars('severity-dist', s.severity);
  }

  // Top Vendors 바
  if (s.top_vendors && s.top_vendors.length > 0) {
    renderVendorBars(s.top_vendors);
  }
}

function renderVendorBars(vendors) {
  const container = document.getElementById('vendor-dist');
  if (!container) return;

  const maxCount = vendors[0]?.count || 1;
  let html = '';
  for (const v of vendors.slice(0, 7)) {
    const pct = ((v.count / maxCount) * 100).toFixed(1);
    const safeName = escapeHtml(v.vendor || '');
    const displayName = safeName.length > 15 ? safeName.slice(0, 15) + '...' : safeName;
    html += `
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
        <span style="width:100px;font-size:11px;color:#8b949e;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${safeName}">${displayName}</span>
        <div style="flex:1;height:6px;background:#21262d;border-radius:3px;overflow:hidden;">
          <div style="width:${pct}%;height:100%;background:#1f6feb;border-radius:3px;"></div>
        </div>
        <span style="width:30px;font-size:11px;color:#e6edf3;text-align:right;">${Number(v.count) || 0}</span>
      </div>`;
  }
  container.innerHTML = html;
}

function setText(id, val) {
  const el = document.getElementById(id);
  if (el) el.textContent = typeof val === 'number' ? val.toLocaleString() : val;
}

// ===== 차트 =====
function renderChart() {
  const trend = statsData.cve?.daily_trend || [];
  const chartData = trend.map(d => ({
    label: d.date,
    value: d.count,
    color: '#1f6feb',
  }));
  drawBarChart('trend-chart', chartData);
}

// ===== 벤더 필터 =====
function buildVendorFilter() {
  const vendors = new Map();
  allCves.forEach(cve => {
    (cve.affected || []).forEach(a => {
      const v = a.vendor;
      if (v && v !== 'Unknown') vendors.set(v, (vendors.get(v) || 0) + 1);
    });
  });

  const sorted = [...vendors.entries()].sort((a, b) => b[1] - a[1]).slice(0, 30);
  const select = document.getElementById('vendor-filter');
  if (!select) return;
  sorted.forEach(([v, c]) => {
    const opt = document.createElement('option');
    opt.value = v.toLowerCase();
    opt.textContent = `${v} (${c})`;
    select.appendChild(opt);
  });
}

// ===== 필터링 =====
function applyFilters() {
  const search = activeFilters.search.toLowerCase();
  const vendor = activeFilters.vendor.toLowerCase();

  filteredCves = allCves.filter(cve => {
    // 심각도 필터
    if (!activeFilters.severity.has(cve.severity || 'None')) return false;

    // 검색
    if (search) {
      const haystack = `${cve.id} ${cve.title} ${cve.description}`.toLowerCase();
      if (!haystack.includes(search)) return false;
    }

    // 벤더 필터
    if (vendor) {
      const match = (cve.affected || []).some(a =>
        (a.vendor || '').toLowerCase().includes(vendor)
      );
      if (!match) return false;
    }

    return true;
  });

  // 정렬
  filteredCves.sort((a, b) => {
    let va, vb;
    switch (sortField) {
      case 'cvss': va = a.cvss || 0; vb = b.cvss || 0; break;
      case 'epss': va = a.epss || 0; vb = b.epss || 0; break;
      case 'date': va = a.date || ''; vb = b.date || ''; break;
      case 'id': va = a.id || ''; vb = b.id || ''; break;
      default: va = a.date || ''; vb = b.date || '';
    }
    if (va < vb) return sortDir;
    if (va > vb) return -sortDir;
    return 0;
  });

  currentPage = 1;
  renderTable();
  renderPagination();
}

// ===== 테이블 렌더링 =====
function renderTable() {
  const tbody = document.getElementById('cve-table-body');
  if (!tbody) return;

  const start = (currentPage - 1) * PAGE_SIZE;
  const page = filteredCves.slice(start, start + PAGE_SIZE);

  if (page.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="icon">&#128269;</div><p>조건에 맞는 CVE가 없습니다.</p></td></tr>';
    return;
  }

  tbody.innerHTML = page.map(cve => {
    const sevClass = `badge-${(cve.severity || 'none').toLowerCase()}`;
    const vendor = cve.affected?.[0]?.vendor || '-';
    const product = cve.affected?.[0]?.product || '-';
    const dateStr = cve.date ? new Date(cve.date).toLocaleDateString('ko-KR') : '-';
    const kevBadge = cve.is_kev ? '<span class="badge badge-kev">KEV</span>' : '';

    return `<tr data-severity="${cve.severity || 'None'}" onclick="showDetail('${cve.id}')">
      <td><span class="cve-id">${cve.id}</span></td>
      <td>${escapeHtml(cve.title || 'N/A')}</td>
      <td><span class="badge ${sevClass}">${cve.severity || '-'}</span></td>
      <td class="score-cell">${(cve.cvss || 0).toFixed(1)}</td>
      <td class="score-cell">${((cve.epss || 0) * 100).toFixed(2)}%</td>
      <td>${kevBadge}</td>
      <td><span class="vendor-product">${escapeHtml(vendor)}/${escapeHtml(product)}</span></td>
      <td>${dateStr}</td>
    </tr>`;
  }).join('');
}

// ===== 페이지네이션 =====
function renderPagination() {
  const totalPages = Math.ceil(filteredCves.length / PAGE_SIZE);
  const info = document.getElementById('page-info');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');

  if (info) info.textContent = `${currentPage} / ${totalPages} (${filteredCves.length}건)`;
  if (prevBtn) prevBtn.disabled = currentPage <= 1;
  if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
}

function changePage(delta) {
  const totalPages = Math.ceil(filteredCves.length / PAGE_SIZE);
  currentPage = Math.max(1, Math.min(totalPages, currentPage + delta));
  renderTable();
  renderPagination();
  window.scrollTo({ top: document.querySelector('.table-wrapper')?.offsetTop - 80, behavior: 'smooth' });
}

// ===== 정렬 =====
function sortBy(field) {
  if (sortField === field) {
    sortDir *= -1;
  } else {
    sortField = field;
    sortDir = -1;
  }
  applyFilters();
}

// ===== 상세 모달 =====
function showDetail(cveId) {
  const cve = allCves.find(c => c.id === cveId);
  if (!cve) return;

  document.getElementById('modal-title').textContent = cve.id;

  const body = document.getElementById('modal-body');
  const sevClass = `badge-${(cve.severity || 'none').toLowerCase()}`;
  const affectedHtml = (cve.affected || []).map(a =>
    `<div>${escapeHtml(a.vendor)} / ${escapeHtml(a.product)} (${escapeHtml(a.versions || '-')})</div>`
  ).join('') || '<div>정보 없음</div>';

  const cweHtml = (cve.cwe || []).join(', ') || 'N/A';

  body.innerHTML = `
    <div class="detail-row">
      <span class="detail-label">제목</span>
      <span class="detail-value">${escapeHtml(cve.title || 'N/A')}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">심각도</span>
      <span class="detail-value"><span class="badge ${sevClass}">${cve.severity}</span> CVSS ${(cve.cvss || 0).toFixed(1)} / EPSS ${((cve.epss || 0) * 100).toFixed(2)}%</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">KEV</span>
      <span class="detail-value">${cve.is_kev ? 'YES' : 'No'}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">CWE</span>
      <span class="detail-value">${cweHtml}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">영향 자산</span>
      <span class="detail-value">${affectedHtml}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">설명</span>
      <span class="detail-value">${escapeHtml(cve.description || 'N/A')}</span>
    </div>
    ${isSafeUrl(cve.report_url) ? `<a href="${escapeHtml(cve.report_url)}" target="_blank" rel="noopener noreferrer" class="report-link">AI 상세 분석 리포트 보기</a>` : ''}
  `;

  document.getElementById('modal-overlay').classList.add('active');
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('active');
}

// ===== 유틸 =====
function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function isSafeUrl(url) {
  if (!url) return false;
  try {
    const parsed = new URL(url);
    return parsed.protocol === 'https:' || parsed.protocol === 'http:';
  } catch {
    return false;
  }
}

// ===== 이벤트 바인딩 =====
document.addEventListener('DOMContentLoaded', () => {
  init();

  // 검색
  const searchEl = document.getElementById('search-input');
  if (searchEl) {
    let timer;
    searchEl.addEventListener('input', () => {
      clearTimeout(timer);
      timer = setTimeout(() => {
        activeFilters.search = searchEl.value;
        applyFilters();
      }, 300);
    });
  }

  // 벤더 필터
  const vendorEl = document.getElementById('vendor-filter');
  if (vendorEl) vendorEl.addEventListener('change', () => {
    activeFilters.vendor = vendorEl.value;
    applyFilters();
  });

  // 심각도 필터 버튼
  document.querySelectorAll('.severity-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const sev = btn.dataset.severity;
      if (activeFilters.severity.has(sev)) {
        activeFilters.severity.delete(sev);
        btn.classList.remove('active');
      } else {
        activeFilters.severity.add(sev);
        btn.classList.add('active');
      }
      applyFilters();
    });
  });

  // 모달 닫기
  document.getElementById('modal-overlay')?.addEventListener('click', (e) => {
    if (e.target === e.currentTarget) closeModal();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
  });
});
